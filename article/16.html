<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><title>Race condition 발생시키고 Mutex lock으로 해결하기</title><meta name="viewport"content="width=device-width,initial-scale=1"><meta http-equiv="X-UA-Compatible"content="ie=edge"><meta name="theme-color"content="#F5F5F5"><meta name="description"content="race condition은 두 개 이상의 프로세스나 스레드가 하나의 데이터를 공유할 때 데이터가 동기화되지 않는 상황을 말한다. (공룡책으로 정리하는 운영체제 Ch.6에 정리했다.) 그리고 코드에서 이러한 문제가 발생할 수 있는 부분을 critical section이라고 하며, 이 문제를 해결하기 위해 한 번에 하나의 ..."><link rel="canonical"href="https://parksb.github.io/article/16.html"><meta name="fediverse:creator"content="@parksb@silicon.moe"><meta property="og:title"content="Race condition 발생시키고 Mutex lock으로 해결하기"><meta property="og:image"content="https://og-image-parksb.vercel.app/api/parksb-github-io?title=Race%20condition%20%EB%B0%9C%EC%83%9D%EC%8B%9C%ED%82%A4%EA%B3%A0%20Mutex%20lock%EC%9C%BC%EB%A1%9C%20%ED%95%B4%EA%B2%B0%ED%95%98%EA%B8%B0&subtitle=&date=2018.06.11"><meta property="og:description"content="race condition은 두 개 이상의 프로세스나 스레드가 하나의 데이터를 공유할 때 데이터가 동기화되지 않는 상황을 말한다. (공룡책으로 정리하는 운영체제 Ch.6에 정리했다.) 그리고 코드에서 이러한 문제가 발생할 수 있는 부분을 critical section이라고 하며, 이 문제를 해결하기 위해 한 번에 하나의 ..."><meta name="twitter:title"content="Race condition 발생시키고 Mutex lock으로 해결하기"><meta name="twitter:image"content="https://og-image-parksb.vercel.app/api/parksb-github-io?title=Race%20condition%20%EB%B0%9C%EC%83%9D%EC%8B%9C%ED%82%A4%EA%B3%A0%20Mutex%20lock%EC%9C%BC%EB%A1%9C%20%ED%95%B4%EA%B2%B0%ED%95%98%EA%B8%B0&subtitle=&date=2018.06.11"><meta name="twitter:description"content="race condition은 두 개 이상의 프로세스나 스레드가 하나의 데이터를 공유할 때 데이터가 동기화되지 않는 상황을 말한다. (공룡책으로 정리하는 운영체제 Ch.6에 정리했다.) 그리고 코드에서 이러한 문제가 발생할 수 있는 부분을 critical section이라고 하며, 이 문제를 해결하기 위해 한 번에 하나의 ..."><meta name="twitter:card"content="summary_large_image"><link rel="shortcut icon"href="../assets/favicon.ico"type="image/x-icon"><link rel="preload"href="https://cdn.jsdelivr.net/gh/parksb/cdn@master/font/Pretendard/woff2/Pretendard-VF-Distilled.woff2"as="font"type="font/woff2"crossorigin><link rel="preload"href="https://cdn.jsdelivr.net/gh/parksb/cdn@master/font/RobotoMono/woff2/RobotoMono-VF-Distilled.woff2"as="font"type="font/woff2"crossorigin><style>@font-face { font-family: 'Pretendard'; src: url('https://cdn.jsdelivr.net/gh/parksb/cdn@master/font/Pretendard/woff2/Pretendard-VF-Distilled.woff2'), local('Pretendard') format('woff2'); font-display: swap; }
      @font-face { font-family: 'RobotoMono'; src: local('RobotoMono'), url('https://cdn.jsdelivr.net/gh/parksb/cdn@master/font/RobotoMono/woff2/RobotoMono-VF-Distilled.woff2') format('woff2'); font-display: swap; }
      a:hover { color: #005ccc !important; }
      #article-content-container a:hover, #article-content-container a:focus { text-decoration: underline !important; }
      #article-content-container .table-of-contents ul li:before { content: counters(item, ".") ". "; counter-increment: item; }
      #article-content-container .footnotes > .footnotes-list > .footnote-item > span { font-size: 0.9rem; }</style></head><body style="font-family: Pretendard,sans-serif; font-size: 16px; margin: 0; padding: 20px 30px 50px 30px; word-break: keep-all;"><header id="top-container"role="navigation"><nav><a class="special-anchor"href="/"style="color: #000; text-decoration: none; cursor: pointer;"><span class="t1"style="font-size: 1.5rem; font-weight: 800;">박성범</span> <span class="t2"style="font-size: 1rem; font-weight: 400;">Simon Park</span></a></nav></header><main id="main-container"style="max-width: 800px; margin-top: 30px; margin-bottom: 30px;"><article id="article-container"><div class="back-to-article-list"style="font-size: 1rem; margin-bottom: 1rem;"><a href="../articles.html"style="color: #000; text-decoration: none; cursor: pointer;"><span class="symbol"style="font-family: Pretendard,sans-serif;">←</span> Articles</a></div><h1 id="article-title"style="margin: 0; padding: 0; font-size: 1.5rem; font-weight: 700;">Race condition 발생시키고 Mutex lock으로 해결하기</h1><a href="https://github.com/parksb/parksb.github.io/commits/development/_articles/20180611_resolving-race-condition-using-mutex.md"style="color: #000; text-decoration: none; cursor: pointer;"><time id="article-date"style="font-family: RobotoMono,monospace; font-size: .8rem;">2018.06.11<span class="symbol"style="font-family: Pretendard,sans-serif;">↗</span></time></a><section id="article-content-container"style="margin-top: 30px;"><details style="margin: 0; padding: 0; display: inline; margin-bottom: 10px;"><summary style="font-weight: 700; cursor: pointer;">Table of Contents</summary><p style="font-size: 1rem; line-height: 1.7rem; margin-bottom: 1rem;"></p><div class="table-of-contents"style="font-size: 15px;"><ul style="padding: 0; margin-left: 2rem; list-style-type: none; counter-reset: item; margin: 0; padding-left: 1rem;"></ul></div><p style="font-size: 1rem; line-height: 1.7rem; margin-bottom: 1rem;"></p></details><p style="font-size: 1rem; line-height: 1.7rem; margin-bottom: 1rem;">race condition은 두 개 이상의 프로세스나 스레드가 하나의 데이터를 공유할 때 데이터가 동기화되지 않는 상황을 말한다. (<a href="https://parksb.github.io/article/10.html"style="text-decoration: none; cursor: pointer; color: #005ccc;">공룡책으로 정리하는 운영체제 Ch.6</a>에 정리했다.) 그리고 코드에서 이러한 문제가 발생할 수 있는 부분을 critical section이라고 하며, 이 문제를 해결하기 위해 한 번에 하나의 스레드만 critical section에 진입할 수 있도록 제어하는 기법을 mutex lock이라고 한다.</p><p style="font-size: 1rem; line-height: 1.7rem; margin-bottom: 1rem;">CentOS에서 3개의 스레드를 운영하는 프로그램을 짜고, race condition을 발생시킨 뒤 mutex lock을 통해 해결해보려 한다. 먼저 3개의 스레드를 만들어보자.</p><pre class="shiki github-light"style="display: block; overflow-x: auto; padding-left: 1rem; margin-bottom: 1rem; line-height: 1.3rem; background-color: #fff; color: #24292e;"tabindex="0"><code class="language-c"style="font-family: RobotoMono,monospace;"><span class="line"><span style="color:#D73A49">#include</span><span style="color:#032F62"> &#x3C;stdio.h></span></span>
<span class="line"><span style="color:#D73A49">#include</span><span style="color:#032F62"> &#x3C;pthread.h></span></span>
<span class="line"><span style="color:#D73A49">#include</span><span style="color:#032F62"> &#x3C;time.h></span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">void*</span><span style="color:#6F42C1"> performThread</span><span style="color:#24292E">(</span><span style="color:#D73A49">void*</span><span style="color:#E36209"> data</span><span style="color:#24292E">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">int</span><span style="color:#24292E"> count </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">int</span><span style="color:#6F42C1"> main</span><span style="color:#24292E">(</span><span style="color:#D73A49">int</span><span style="color:#E36209"> argc</span><span style="color:#24292E">, </span><span style="color:#D73A49">char*</span><span style="color:#E36209"> argv</span><span style="color:#D73A49">[]</span><span style="color:#24292E">) {</span></span>
<span class="line"><span style="color:#D73A49">  pthread_t</span><span style="color:#E36209"> threads</span><span style="color:#24292E">[</span><span style="color:#005CC5">3</span><span style="color:#24292E">];</span></span>
<span class="line"><span style="color:#D73A49">  char</span><span style="color:#E36209"> threadNames</span><span style="color:#24292E">[</span><span style="color:#005CC5">3</span><span style="color:#24292E">][</span><span style="color:#005CC5">128</span><span style="color:#24292E">] </span><span style="color:#D73A49">=</span><span style="color:#24292E"> {</span></span>
<span class="line"><span style="color:#24292E">    {</span><span style="color:#032F62">"thread1"</span><span style="color:#24292E">},</span></span>
<span class="line"><span style="color:#24292E">    {</span><span style="color:#032F62">"thread2"</span><span style="color:#24292E">},</span></span>
<span class="line"><span style="color:#24292E">    {</span><span style="color:#032F62">"thread3"</span><span style="color:#24292E">}</span></span>
<span class="line"><span style="color:#24292E">  };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1">  pthread_create</span><span style="color:#24292E">(</span><span style="color:#D73A49">&#x26;</span><span style="color:#E36209">threads</span><span style="color:#24292E">[</span><span style="color:#005CC5">0</span><span style="color:#24292E">], </span><span style="color:#005CC5">NULL</span><span style="color:#24292E">, performThread, (</span><span style="color:#D73A49">void*</span><span style="color:#24292E">)</span><span style="color:#E36209">threadNames</span><span style="color:#24292E">[</span><span style="color:#005CC5">0</span><span style="color:#24292E">]);</span></span>
<span class="line"><span style="color:#6F42C1">  pthread_create</span><span style="color:#24292E">(</span><span style="color:#D73A49">&#x26;</span><span style="color:#E36209">threads</span><span style="color:#24292E">[</span><span style="color:#005CC5">1</span><span style="color:#24292E">], </span><span style="color:#005CC5">NULL</span><span style="color:#24292E">, performThread, (</span><span style="color:#D73A49">void*</span><span style="color:#24292E">)</span><span style="color:#E36209">threadNames</span><span style="color:#24292E">[</span><span style="color:#005CC5">1</span><span style="color:#24292E">]);</span></span>
<span class="line"><span style="color:#6F42C1">  pthread_create</span><span style="color:#24292E">(</span><span style="color:#D73A49">&#x26;</span><span style="color:#E36209">threads</span><span style="color:#24292E">[</span><span style="color:#005CC5">2</span><span style="color:#24292E">], </span><span style="color:#005CC5">NULL</span><span style="color:#24292E">, performThread, (</span><span style="color:#D73A49">void*</span><span style="color:#24292E">)</span><span style="color:#E36209">threadNames</span><span style="color:#24292E">[</span><span style="color:#005CC5">2</span><span style="color:#24292E">]);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1">  printf</span><span style="color:#24292E">(</span><span style="color:#032F62">"</span><span style="color:#005CC5">%d\n</span><span style="color:#032F62">"</span><span style="color:#24292E">, count);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">  return</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#24292E">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">void*</span><span style="color:#6F42C1"> performThread</span><span style="color:#24292E">(</span><span style="color:#D73A49">void*</span><span style="color:#E36209"> data</span><span style="color:#24292E">) {</span></span>
<span class="line"><span style="color:#24292E">  count</span><span style="color:#D73A49">++</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#24292E">}</span></span></code></pre><p style="font-size: 1rem; line-height: 1.7rem; margin-bottom: 1rem;">3개의 스레드가 차례대로 <code style="font-family: RobotoMono,monospace;">count</code>를 증가시켰기 때문에 예상대로 결과는 3이 나온다. 이걸 조금 바꿔서 <code style="font-family: RobotoMono,monospace;">count</code>를 10만번 증가시키고, 모든 내용을 로그에 남기도록 하려한다. <code style="font-family: RobotoMono,monospace;">performThread</code>만 수정해주면 된다.</p><pre class="shiki github-light"style="display: block; overflow-x: auto; padding-left: 1rem; margin-bottom: 1rem; line-height: 1.3rem; background-color: #fff; color: #24292e;"tabindex="0"><code class="language-c"style="font-family: RobotoMono,monospace;"><span class="line"><span style="color:#D73A49">void*</span><span style="color:#6F42C1"> performThread</span><span style="color:#24292E">(</span><span style="color:#D73A49">void*</span><span style="color:#E36209"> data</span><span style="color:#24292E">) {</span></span>
<span class="line"><span style="color:#D73A49">  time_t</span><span style="color:#24292E"> currentTime;</span></span>
<span class="line"><span style="color:#D73A49">  struct</span><span style="color:#24292E"> tm</span><span style="color:#D73A49">*</span><span style="color:#24292E"> timeInfo;</span></span>
<span class="line"><span style="color:#D73A49">  char</span><span style="color:#E36209"> currentTimeString</span><span style="color:#24292E">[</span><span style="color:#005CC5">128</span><span style="color:#24292E">];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">  char*</span><span style="color:#24292E"> threadName </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (</span><span style="color:#D73A49">char*</span><span style="color:#24292E">)data;</span></span>
<span class="line"><span style="color:#24292E">  FILE</span><span style="color:#D73A49">*</span><span style="color:#24292E"> file;</span></span>
<span class="line"><span style="color:#D73A49">  int</span><span style="color:#24292E"> i </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E">  file </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> fopen</span><span style="color:#24292E">(</span><span style="color:#032F62">"event.log"</span><span style="color:#24292E">, </span><span style="color:#032F62">"a"</span><span style="color:#24292E">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">  for</span><span style="color:#24292E"> (i </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">; i </span><span style="color:#D73A49">&#x3C;</span><span style="color:#005CC5"> 100000</span><span style="color:#24292E">; i</span><span style="color:#D73A49">++</span><span style="color:#24292E">) {</span></span>
<span class="line"><span style="color:#6F42C1">    time</span><span style="color:#24292E">(</span><span style="color:#D73A49">&#x26;</span><span style="color:#24292E">currentTime);</span></span>
<span class="line"><span style="color:#24292E">    timeInfo </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> localtime</span><span style="color:#24292E">(</span><span style="color:#D73A49">&#x26;</span><span style="color:#24292E">currentTime);</span></span>
<span class="line"><span style="color:#6F42C1">    strftime</span><span style="color:#24292E">(currentTimeString, </span><span style="color:#005CC5">128</span><span style="color:#24292E">, </span><span style="color:#032F62">"</span><span style="color:#B31D28;font-style:italic">%</span><span style="color:#032F62">Y-</span><span style="color:#B31D28;font-style:italic">%</span><span style="color:#032F62">m-</span><span style="color:#005CC5">%d</span><span style="color:#B31D28;font-style:italic"> %</span><span style="color:#032F62">H:</span><span style="color:#B31D28;font-style:italic">%</span><span style="color:#032F62">M:</span><span style="color:#005CC5">%S</span><span style="color:#032F62">"</span><span style="color:#24292E">, timeInfo);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1">    fprintf</span><span style="color:#24292E">(file, </span><span style="color:#032F62">"</span><span style="color:#005CC5">%s\t%s\t%d\n</span><span style="color:#032F62">"</span><span style="color:#24292E">, currentTimeString, threadName, count);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E">    count</span><span style="color:#D73A49">++</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#24292E">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1">  fclose</span><span style="color:#24292E">(file);</span></span>
<span class="line"><span style="color:#24292E">}</span></span></code></pre><p style="font-size: 1rem; line-height: 1.7rem; margin-bottom: 1rem;">반복문을 10만번 돌면서 시간, 스레드 이름, <code style="font-family: RobotoMono,monospace;">count</code> 순서로 로그를 한 줄씩 남기도록 수정하고 실행한다.</p><p style="font-size: 1rem; line-height: 1.7rem; margin-bottom: 1rem;"><img src="/images/50655469-a575fd00-0fd3-11e9-86c4-54add9d239f4.webp"alt decoding="async"width="186"height="379"style="max-width: 100%; height: auto; margin-bottom: -7px;"></p><p style="font-size: 1rem; line-height: 1.7rem; margin-bottom: 1rem;">엄청난 빈도로 race condition이 발생했으며, 최종 결과가 정확히 300000으로 떨어지지 않았다. 이에 앞서 VM에서 테스트하면서 race condition이 일어나지 않아 삽질을 많이 했는데, VM을 싱글 코어로 설정해서 그런 것이었다.</p><p style="font-size: 1rem; line-height: 1.7rem; margin-bottom: 1rem;"><img src="/images/50655465-a3ac3980-0fd3-11e9-856b-a5f67445bb09.webp"alt loading="lazy"decoding="async"width="800"height="613"style="max-width: 100%; height: auto; margin-bottom: -7px;"></p><p style="font-size: 1rem; line-height: 1.7rem; margin-bottom: 1rem;">위와 같이 싱글 코어 환경에서는 한 번에 하나의 스레드만 실행되기 때문에 race condition이 발생하지 않는다.</p><p style="font-size: 1rem; line-height: 1.7rem; margin-bottom: 1rem;">다시 멀티 코어 환경으로 돌아와서, race condition을 mutex lock으로 해결해본다.</p><pre class="shiki github-light"style="display: block; overflow-x: auto; padding-left: 1rem; margin-bottom: 1rem; line-height: 1.3rem; background-color: #fff; color: #24292e;"tabindex="0"><code class="language-c"style="font-family: RobotoMono,monospace;"><span class="line"><span style="color:#D73A49">#include</span><span style="color:#032F62"> &#x3C;stdio.h></span></span>
<span class="line"><span style="color:#D73A49">#include</span><span style="color:#032F62"> &#x3C;pthread.h></span></span>
<span class="line"><span style="color:#D73A49">#include</span><span style="color:#032F62"> &#x3C;time.h></span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">void*</span><span style="color:#6F42C1"> performThread</span><span style="color:#24292E">(</span><span style="color:#D73A49">void*</span><span style="color:#E36209"> data</span><span style="color:#24292E">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">pthread_mutex_t</span><span style="color:#24292E"> mutex </span><span style="color:#D73A49">=</span><span style="color:#24292E"> PTHREAD_MUTEX_INITIALIZER;</span></span>
<span class="line"><span style="color:#D73A49">int</span><span style="color:#24292E"> counter </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#24292E">FILE</span><span style="color:#D73A49">*</span><span style="color:#24292E"> file;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">int</span><span style="color:#6F42C1"> main</span><span style="color:#24292E">(</span><span style="color:#D73A49">int</span><span style="color:#E36209"> argc</span><span style="color:#24292E">, </span><span style="color:#D73A49">char*</span><span style="color:#E36209"> argv</span><span style="color:#D73A49">[]</span><span style="color:#24292E">) {</span></span>
<span class="line"><span style="color:#D73A49">  pthread_t</span><span style="color:#E36209"> threads</span><span style="color:#24292E">[</span><span style="color:#005CC5">3</span><span style="color:#24292E">];</span></span>
<span class="line"><span style="color:#D73A49">  char</span><span style="color:#E36209"> threadNames</span><span style="color:#24292E">[</span><span style="color:#005CC5">3</span><span style="color:#24292E">][</span><span style="color:#005CC5">128</span><span style="color:#24292E">] </span><span style="color:#D73A49">=</span><span style="color:#24292E"> {</span></span>
<span class="line"><span style="color:#24292E">    {</span><span style="color:#032F62">"thread1"</span><span style="color:#24292E">},</span></span>
<span class="line"><span style="color:#24292E">    {</span><span style="color:#032F62">"thread2"</span><span style="color:#24292E">},</span></span>
<span class="line"><span style="color:#24292E">    {</span><span style="color:#032F62">"thread3"</span><span style="color:#24292E">}</span></span>
<span class="line"><span style="color:#24292E">  };</span></span>
<span class="line"><span style="color:#D73A49">  int</span><span style="color:#24292E"> i </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E">  file </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> fopen</span><span style="color:#24292E">(</span><span style="color:#032F62">"event.log"</span><span style="color:#24292E">, </span><span style="color:#032F62">"a"</span><span style="color:#24292E">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">  for</span><span style="color:#24292E"> (i </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">; i </span><span style="color:#D73A49">&#x3C;</span><span style="color:#005CC5"> 100000</span><span style="color:#24292E">; i</span><span style="color:#D73A49">++</span><span style="color:#24292E">) {</span></span>
<span class="line"><span style="color:#6F42C1">    pthread_create</span><span style="color:#24292E">(</span><span style="color:#D73A49">&#x26;</span><span style="color:#E36209">threads</span><span style="color:#24292E">[</span><span style="color:#005CC5">0</span><span style="color:#24292E">], </span><span style="color:#005CC5">NULL</span><span style="color:#24292E">, performThread, (</span><span style="color:#D73A49">void*</span><span style="color:#24292E">)</span><span style="color:#E36209">threadNames</span><span style="color:#24292E">[</span><span style="color:#005CC5">0</span><span style="color:#24292E">]);</span></span>
<span class="line"><span style="color:#6F42C1">    pthread_create</span><span style="color:#24292E">(</span><span style="color:#D73A49">&#x26;</span><span style="color:#E36209">threads</span><span style="color:#24292E">[</span><span style="color:#005CC5">1</span><span style="color:#24292E">], </span><span style="color:#005CC5">NULL</span><span style="color:#24292E">, performThread, (</span><span style="color:#D73A49">void*</span><span style="color:#24292E">)</span><span style="color:#E36209">threadNames</span><span style="color:#24292E">[</span><span style="color:#005CC5">1</span><span style="color:#24292E">]);</span></span>
<span class="line"><span style="color:#6F42C1">    pthread_create</span><span style="color:#24292E">(</span><span style="color:#D73A49">&#x26;</span><span style="color:#E36209">threads</span><span style="color:#24292E">[</span><span style="color:#005CC5">2</span><span style="color:#24292E">], </span><span style="color:#005CC5">NULL</span><span style="color:#24292E">, performThread, (</span><span style="color:#D73A49">void*</span><span style="color:#24292E">)</span><span style="color:#E36209">threadNames</span><span style="color:#24292E">[</span><span style="color:#005CC5">2</span><span style="color:#24292E">]);</span></span>
<span class="line"><span style="color:#24292E">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1">  printf</span><span style="color:#24292E">(</span><span style="color:#032F62">"Done: </span><span style="color:#005CC5">%d\n</span><span style="color:#032F62">"</span><span style="color:#24292E">, counter);</span></span>
<span class="line"><span style="color:#6F42C1">  fclose</span><span style="color:#24292E">(file);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">  return</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">;</span></span>
<span class="line"><span style="color:#24292E">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">void*</span><span style="color:#6F42C1"> performThread</span><span style="color:#24292E">(</span><span style="color:#D73A49">void*</span><span style="color:#E36209"> data</span><span style="color:#24292E">) {</span></span>
<span class="line"><span style="color:#6F42C1">  pthread_mutex_lock</span><span style="color:#24292E">(</span><span style="color:#D73A49">&#x26;</span><span style="color:#24292E">mutex);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">  time_t</span><span style="color:#24292E"> currentTime;</span></span>
<span class="line"><span style="color:#D73A49">  struct</span><span style="color:#24292E"> tm</span><span style="color:#D73A49">*</span><span style="color:#24292E"> timeInfo;</span></span>
<span class="line"><span style="color:#D73A49">  char</span><span style="color:#E36209"> currentTimeString</span><span style="color:#24292E">[</span><span style="color:#005CC5">128</span><span style="color:#24292E">];</span></span>
<span class="line"><span style="color:#D73A49">  char*</span><span style="color:#24292E"> threadName </span><span style="color:#D73A49">=</span><span style="color:#24292E"> (</span><span style="color:#D73A49">char*</span><span style="color:#24292E">)data;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1">  time</span><span style="color:#24292E">(</span><span style="color:#D73A49">&#x26;</span><span style="color:#24292E">currentTime);</span></span>
<span class="line"><span style="color:#24292E">  timeInfo </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> localtime</span><span style="color:#24292E">(</span><span style="color:#D73A49">&#x26;</span><span style="color:#24292E">currentTime);</span></span>
<span class="line"><span style="color:#6F42C1">  strftime</span><span style="color:#24292E">(currentTimeString, </span><span style="color:#005CC5">128</span><span style="color:#24292E">, </span><span style="color:#032F62">"</span><span style="color:#B31D28;font-style:italic">%</span><span style="color:#032F62">Y-</span><span style="color:#B31D28;font-style:italic">%</span><span style="color:#032F62">m-</span><span style="color:#005CC5">%d</span><span style="color:#B31D28;font-style:italic"> %</span><span style="color:#032F62">H:</span><span style="color:#B31D28;font-style:italic">%</span><span style="color:#032F62">M:</span><span style="color:#005CC5">%S</span><span style="color:#032F62">"</span><span style="color:#24292E">, timeInfo);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1">  fprintf</span><span style="color:#24292E">(file, </span><span style="color:#032F62">"</span><span style="color:#005CC5">%s\t%s\t%d\n</span><span style="color:#032F62">"</span><span style="color:#24292E">, currentTimeString, threadName, counter);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E">  counter</span><span style="color:#D73A49">++</span><span style="color:#24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1">  pthread_mutex_unlock</span><span style="color:#24292E">(</span><span style="color:#D73A49">&#x26;</span><span style="color:#24292E">mutex);</span></span>
<span class="line"><span style="color:#24292E">}</span></span></code></pre><p style="font-size: 1rem; line-height: 1.7rem; margin-bottom: 1rem;">먼저 <code style="font-family: RobotoMono,monospace;">mutex</code> 변수를 만들었다. 그리고 critical section은 <code style="font-family: RobotoMono,monospace;">performThread</code> 함수에서 로그를 남기고 <code style="font-family: RobotoMono,monospace;">counter</code>를 증가시키는 부분이므로, 스레드가 <code style="font-family: RobotoMono,monospace;">performThread</code>에 진입할 때 lock해 다른 스레드가 진입할 수 없도록 만든 후 나올 때는 unlock해주도록 했다.</p><p style="font-size: 1rem; line-height: 1.7rem; margin-bottom: 1rem;"><img src="/images/50655470-a870ed80-0fd3-11e9-9917-b1fede3dcea0.webp"alt loading="lazy"decoding="async"width="356"height="429"style="max-width: 100%; height: auto; margin-bottom: -7px;"></p><p style="font-size: 1rem; line-height: 1.7rem; margin-bottom: 1rem;">최종 값은 299999였다. <code style="font-family: RobotoMono,monospace;">counter</code>가 0에서 출발하니까 최종 값이 299999이어야 각 스레드가 100000번씩 수행되었다는 의미가 된다. 잘 동작했다.</p></section><section id="article-navigation"style="margin-top: 50px; overflow: hidden;"><div class="article-navigation-item article-navigation-next"style="margin-bottom: 1rem; text-align: left; float: left; margin-right: 5px;"><a href="17.html"style="color: #000; text-decoration: none; cursor: pointer;"><div class="article-navigation-arrow article-navigation-next symbol"style="font-family: Pretendard,sans-serif; font-size: .9rem; text-align: left; float: left; margin-right: 5px;">←</div><div class="article-navigation-content article-navigation-next"style="text-align: left; float: left; margin-right: 5px;"><p class="article-navigation-title"style="font-weight: 700; font-size: 1rem; margin: 0;">Java Design Pattern: Singleton</p><p class="article-navigation-subtitle"style="font-weight: 400; font-size: .8rem; margin: 0;"></p></div></a></div><div class="article-navigation-item article-navigation-prev"style="margin-bottom: 1rem; text-align: right; float: right; margin-left: 5px;"><a href="15.html"style="color: #000; text-decoration: none; cursor: pointer;"><div class="article-navigation-arrow article-navigation-prev symbol"style="font-family: Pretendard,sans-serif; font-size: .9rem; text-align: right; float: right; margin-left: 5px;">→</div><div class="article-navigation-content article-navigation-prev"style="text-align: right; float: right; margin-left: 5px;"><p class="article-navigation-title"style="font-weight: 700; font-size: 1rem; margin: 0;">🌞 개떡같은 코드와 함께한 하루 리뉴얼 이야기</p><p class="article-navigation-subtitle"style="font-weight: 400; font-size: .8rem; margin: 0;">거대한 레거시를 수습한 경험</p></div></a></div></section><section id="article-comments"><script async src="https://utteranc.es/client.js"repo="parksb/parksb.github.io-comments"issue-term="pathname"theme="github-light"crossorigin="anonymous"></script></section><div class="back-to-article-list"style="font-size: 1rem; margin-bottom: 1rem;"><a href="../articles.html"style="color: #000; text-decoration: none; cursor: pointer;"><span class="symbol"style="font-family: Pretendard,sans-serif;">←</span> Articles</a></div></article></main><footer style="font-size: .8rem; color: #767676;">이 글은 CC BY-NC 4.0 라이선스에 따라 이용할 수 있습니다.</footer><script async src="https://www.googletagmanager.com/gtag/js?id=G-LKTJ5YFJR2"></script><script>window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-LKTJ5YFJR2');</script></body></html>